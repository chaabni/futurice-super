<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="../x-project-card/x-project-card.html">

<polymer-element name="x-project-card-grid" attributes="projects service">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <template repeat="{{ chunk in chunks }}">
      <template repeat="{{ project in chunk }}">
        <x-project-card
          project="{{ project }}"
          on-favorite-tap="{{ handleFavorite }}"
          hidden?="{{ tribe.name !== defaultTribe.name &amp;&amp; project.value.Futu_Team__c !== tribe.name }}"></x-project-card>
      </template>
    </template>
  </template>
  <script>
    Polymer('x-project-card-grid', {
      projects: [],
      chunks: [],
      currentChunkIndex: 0,
      chunkSize: 10,
      ready: function() {
        this.handleFavorite = function(event, detail, sender){
          var project = sender.templateInstance.model.project;
          this.service.setFavorite(project.id, project.favorite);
        };

      },
      projectsChanged: function() {

        this.currentChunkIndex = 0;
        this.chunks = [];

        var array = [];
        for (
          var i = 0;
          i < Math.ceil(this.projects.length / (1.0 * this.chunkSize));
          i++) {
          array[i] = [];
        };

        this.chunks = array;

        if (this.chunks.length > 0) {
          var that = this;
          setTimeout(function() { return that.nextChunk(); }, 150);
        }
      },
      nextChunk: function() {
        var offset = this.chunkSize * this.currentChunkIndex;

        if (offset >= this.projects.length) {
          return true;
        }

        for (var i = 0; i < this.chunkSize; i++) {
          if (!this.projects[offset+i]) {
            break;
          }
          this.chunks[this.currentChunkIndex].push(this.projects[offset+i]);
        };

        this.currentChunkIndex++;

        var that = this;

        setTimeout(function() { return that.nextChunk(); }, 10);
      }
    });
  </script>
</polymer-element>