<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/font-roboto/roboto.html">
<link rel="import" href="../../bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="../../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/core-menu/core-menu.html">
<link rel="import" href="../../bower_components/core-selector/core-selector.html">
<link rel="import" href="../../bower_components/core-localstorage/core-localstorage.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../../elements/x-project-service/x-project-service.html">
<link rel="import" href="../../elements/x-tribe-service/x-tribe-service.html">
<link rel="import" href="../../elements/x-user-service/x-user-service.html">
<link rel="import" href="../../elements/x-project-card-grid/x-project-card-grid.html">

<polymer-element name="x-app">
  <template>
    <style>
      /*
      Colors
      ========================================


      Primary color: Light Green
        500   #8bc34a
      Variant hues:
        100   #dcedc8
        700   #689f38

      Accent: Deep Orange
        A200  #ff6e40
        A700  #dd2c00

      Grayscale:
        #fff
        #fafafa
        #222


      http://www.google.com/design/spec/style/color.html#color-ui-color-palette
      */

      :host {
        display: block;
      }

      core-scaffold {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        color: rgba(0,0,0, 0.8);
      }

      /* Main view's header bar */
      core-scaffold::shadow core-toolbar {
        background-color: #689f38;
        color: #fff;
      }

      /* Main view's background */
      core-scaffold::shadow [main] {
        background-color: #fafafa;
      }

      /* Menu panel's header bar */
      .panel-menu::shadow #mainPanel, .panel-menu core-toolbar {
        background-color: #fff;
      }

      /* Menu panel */
      .panel-menu {
        background-color: #fff;
        z-index: 1;
      }

      .panel-menu h2,
      .panel-menu paper-item {
        padding: 0 1rem;
      }
      .panel-menu .tribe-project-count {
        text-align: right;
      }

      .panel-menu h2 {
        text-transform: uppercase;
        margin: 0;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        font-size: 1.3em;
        border-bottom: 1px solid #eee;
      }

      .panel-menu core-menu {
        margin: 0 0 1rem;
      }

      paper-item.core-selected {
        background-color: #dcedc8;
      }
      paper-item::shadow #ripple {
        color: #8bc34a;
      }

      core-scaffold core-icon-button core-icon {
        color: white;
      }

      core-scaffold /deep/ core-icon-button /deep/ core-icon {
        color: white;
      }

      #superLogo {
        cursor: pointer;
        color: #689f38;
      }

      /* Tutorial */
      #tutorial {
        width: 100%;
        margin: 1em;
        text-align: center;
        color: rgba(0,0,0, 0.5);
      }

      #tutorial h1,h2 {
        font-weight: 300;
        text-shadow: 0 0 5px rgba(255,255,255, 0.7);
      }

      #tutorial h1 {
        font-size: 5em;
        line-height: 1;
        margin: 0;
      }

      #tutorial h2 {
        font-size: 1em;
      }

      #tutorial header {
        margin-bottom: 3em;
      }

      #tutorial img {
        width: 6em;
        opacity: 0.5;
      }

      paper-checkbox {
        padding: 0.7rem 1rem;
      }
      paper-checkbox::shadow #checkbox.checked {
        border-color: #689f38;
      }
      paper-checkbox::shadow #checkboxLabel {
        box-sizing: border-box;
        width: calc(100% - 22px);
        padding-left: 1rem;
      }
      paper-checkbox .tribe-project-count {
        text-align: right;
      }

      @media screen and (min-width: 1000px) {
        #tutorial h1 {
          font-size: 10em;
        }

        #tutorial h2 {
          font-size: 1.5em;
        }

        #tutorial img {
          width: 8em;
        }
      }
    </style>
    <core-localstorage name="super-current-selected" value="{{ selected }}"></core-localstorage>
    <core-localstorage name="super-current-tribe" value="{{ currentTribe }}"></core-localstorage>
    <core-localstorage name="super-current-sortBy" value="{{ sortBy }}"></core-localstorage>

    <core-scaffold id="scaffold">

      <core-header-panel class="panel-menu" navigation flex mode="waterfall">
        <core-toolbar><span id="superLogo" on-tap="{{ clearTribe }}">SUPER</span></core-toolbar>
        <h2>Tribe</h2>
        <core-menu selected="{{ selected }}">
          <template repeat="{{ t in tribes }}">
            <paper-item label="{{ t.prettyName }}" on-tap="{{ handleItemTap }}">
              <template if="{{ t.name === currentTribe.name }}">
                <span flex class="tribe-project-count">
                  {{ currentTribe.projectCount }}
                </span>
              </template>
            </paper-item>
          </template>
        </core-menu>

        <h2>Sort by</h2>
        <core-menu id="sortBy" selected="{{ sortBy }}">
          <template repeat="{{ item in sortOptions }}">
            <paper-item on-tap="{{ sortBySelected }}" name="{{ item.sortKey }}">
              {{ item.prettyName }}
            </paper-item>
          </template>
        </core-menu>

        <h2>Show</h2>
        <core-menu id="filters">
          <div layout vertical>
            <template repeat="{{ item in filterOptions }}">
                <paper-checkbox name="{{ item.name }}" label="{{ item.name }}" checked="{{ item.isChecked }}" on-change="{{ filterChecked }}">
                  <span fit class="tribe-project-count">{{ item.count }}</span>
                </paper-checkbox>
            </template>
          </div>
        </core-menu>
      </core-header-panel>

      <div tool>{{ currentTribe.prettyName }}</div>

      <x-tribe-service id="tribeService" tribes="{{ tribes }}"></x-tribe-service>
      <x-project-service id="projectService" projects="{{ projects }}" user="{{ user }}"></x-project-service>
      <x-user-service id="userService" user="{{ user }}"></x-user-service>


      <section class="card-grid">
        <x-project-card-grid projects="{{ selectedProjects }}" sortBy="{{ sortBy }}" service="{{ projectService }}" user="{{ user }}"
        on-favorite-tap="{{ handleFavorite }}">
          <section id="tutorial">
            <header>
              <h1>SUPER</h1>
              <h2>Salesforce Upcoming Projects Evaluation Rankings</h2>
            </header>

            <img src="/images/curved-arrow-up.svg" alt="Arrow pointing to menu" />
            <p>Please choose your tribe and filters from the menu on the left to see more projects.</p>
          </section>
        </x-project-card-grid>
      </section>

    </core-scaffold>
  </template>
  <script src="/bower_components/underscore/underscore.js"></script>
  <script>
  Polymer('x-app', {
    defaultSortBy: "-LastModifiedDate",
    handleItemTap: function(event, detail, sender) {
      this.selectTribe(sender.templateInstance.model.t);
      this.$.scaffold.closeDrawer();
    },
    sortBySelected: function(event, detail, sender) {
      this.sortBy = this.$.sortBy.selected;
      this.updateList();
    },
    filterChecked: function(event, detail, sender) {
      this.updateList();
    },
    selectTribe: function(tribe) {
      this.currentTribe = {
        name: tribe.name,
        prettyName: tribe.prettyName,
      }
    },
    currentTribeChanged: function(){
      this.updateList();
    },
    updateFilterOptions: function() {
      var self = this;
      self.filterOptions = self.filterConfig.map(function(option) {
        option.count = _.filter(self.projects, function(project) {
          return (
            self.currentTribe.name === project.Futu_Team__c && option.filter(project)
          );
        }).length;
        return option;
      });

      if (self.currentTribe) {
        self.currentTribe.projectCount = self.filterOptions
          .map(function(option) { return option.count; })
          .reduce(function(acc, x) { return acc + x; });
      }
    },
    projectsChanged: function(){
      this.updateList();
    },
    updateList: function(){
      var that = this;
      if (!this.sortBy) {
        this.sortBy = this.defaultSortBy;
      }
      if (this.projects && this.currentTribe) {
        this.selectedProjects = _.filter(
          this.projects,
          function (item) {
            // Check tribe
            if (that.currentTribe.name !== item.Futu_Team__c){
              return false;
            }

            // Filter out unchecked checkboxes
            for (var i = 0; i < that.filterOptions.length; i++) {
              // Start filtering out results if field is unchecked
              if (!that.filterOptions[i].isChecked &&
                that.filterOptions[i].filter(item)) {
                  return false;
              }
            }

            return true;
          });
      } else {
        this.selectedProjects = [];
      }

      this.updateFilterOptions();
    },
    ready: function(){
      this.projectService = this.$.projectService;
      this.sortOptions = [
        { sortKey: "-LastModifiedDate", prettyName: "Last modified" },
        { sortKey: "Budgeted_Work_Start_Date__c", prettyName: "Start date" },
        { sortKey: "-FavoritedBy.length", prettyName: "Most popular" },
        { sortKey: "-FavoritedByUser", prettyName: "My favorites first" },
        { sortKey: "Name", prettyName: "Name" }
      ];

      this.filterOptions = [];
      this.filterConfig = [
        {
          name: "Won",
          isChecked: true,
          filter: function(item){
            return item.IsWon == true;
          }
        },
        {
          name: "Lost",
          isChecked: true,
          filter: function(item) {
            return item.IsClosed && !item.IsWon;
          }
        },
        {
          name: "Open",
          isChecked: true,
          filter: function(item){
            return !item.IsClosed;
          }
        }
      ];
    },
    handleFavorite: function(event, detail, sender){
      this.$.projectService.setFavorites(detail.project);
    },
    clearTribe: function(){
      this.currentTribe = null;
      this.selected = null;
      this.updateList();
    }
  });
  </script>
</polymer-element>
