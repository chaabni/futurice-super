<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-progress/paper-progress.html">
<link rel="import" href="/bower_components/core-icons/core-icons.html">
<link rel="import" href="/bower_components/core-tooltip/core-tooltip.html">

<polymer-element name="x-project-card" attributes="project">
  <template>
    <style>
      :host {
        position: relative;
        overflow: visible;
      }
      .card-inner {
        display: block;
        background-color: #fff;
        padding: 10px;
        position: relative;
        box-shadow: 0px 2px 5px rgba(0,0,0, .3);
      }
      paper-icon-button {
        fill: #e0e0e0;
      }
      :host([favorite]) paper-icon-button {
        fill: #dd2c00;
      }

      .align-right {
        text-align: right;
      }

      h1, h2 {
        font-weight: 300;
      }

      h1 {
        margin: 0 0 15px 0;
      }

      h2 {
        margin: 0;
      }

      paper-progress {
        width: 100%;
      }

      paper-progress::shadow #activeProgress {
        background-color: #8bc34a;
      }

      paper-progress[lost]::shadow #activeProgress {
        background-color: #ff6e40;
      }

      #probability {
        font-size: 2em;
      }

      #amount {
        font-size: 1.5em;
      }

      #description {
        margin: 10px 0;
      }

      #modified {
        font-size: 0.7em;
      }

      .user-face {
        display: inline-block;
        background: transparent 50% 50%;
        background-size: cover;
        width: 2em;
        height: 2em;
        border-radius: 4em;
      }

    </style>
    <div class="card-inner" vertical layout>

      <!-- Title bar-->
      <div layout horizontal>
        <h1 class="project-title" flex>{{ project.value.Name }}</h1>
        <paper-icon-button id="favorite" icon="favorite" on-tap="{{ favoriteTapped }}"></paper-icon-button>
      </div>

      <!-- 2nd title bar -->
      <div horizontal layout justified start>
        <h2>{{ project.value.Account.Name }}</h2>
        <div  class="align-right" vertical layout>
          <h2>{{ project.value.Owner.Name }}</h2>
          <div>{{ project.value.Futu_Team__c }}</div>
        </div>
      </div>

      <!-- Opportunity section  -->
      <div horizontal layout justified>
        <div vertical layout>
          <div hidden?="{{ project.value.IsClosed }}">DL: {{ project.value.CloseDate }}</div>
        </div>
        <div  class="align-right" vertical layout>
          <span id="probability">{{ project.value.Probability }} %</span>
          <span id="amount">{{ project.value.Amount / 1000 }} kâ‚¬</span>
          <span>
            <template repeat="{{ username in project.value.FavoritedBy }}">
              <span class="user-face" data-uuid="{{ username }}" style="background-image: url({{ '//api.fum.futurice.com/photo/' + username }})"></span>
            </template>
          </span>
        </div>
      </div>

      <!-- Project section -->
      <div horizontal layout>
        <div vertical layout flex>
          <div horizontal layout hidden?="{{ hideEvent }}">
            <core-icon icon="event"></core-icon>
            <span>{{ project.value.Budgeted_Work_Start_Date__c || "TBD" }} - {{ project.value.Budgeted_Work_End_Date__c || "TBD" }}</span>
          </div>
          <div id="description" class="project-description">{{ project.value.Description }}</div>
          <core-tooltip label="{{ stage.name }}">
            <paper-progress value="{{ stage.number }}" disabled lost?="{{ project.value.IsClosed &amp;&amp; !project.value.IsWon }}"></paper-progress>
          </core-tooltip>
          <div id="modified" horizontal layout>
            <div>Modified: {{ modified }}</div>
          </div>
        </div>
      </div>

    </div>
  </template>
  <script src="../../bower_components/moment/moment.js"></script>
  <script>
    Polymer('x-project-card', {
      publish: {
        favorite: {
          value: false,
          reflect: true
        }
      },
      hideEvent: true,
      favoriteTapped: function(event, detail, sender) {
        this.fire('favorite-tap', {project: this.project});
      },
      stageNumbers: {
        "Unqualified": 0,
        "Qualified": 20,
        "Working on Proposal": 40,
        "Closing": 60,
        "Contract negotiations": 80,
        "Won": 100,
        "Lost": 100
      },
      projectChanged: function(){
        this.stage = {};

        if (!!this.project) {
          if (this.project.value.IsClosed) {
            if (this.project.value.IsWon) {
              this.stage.name = "Won";
            } else {
              this.stage.name = "Lost";
            }
          } else {
            this.stage.name = this.project.value.StageName;
          }
          this.stage.number = this.stageNumbers[this.stage.name];


          // Hide dates if not available
          if (this.project.value.Budgeted_Work_Start_Date__c !== null || this.project.value.Budgeted_Work_End_Date__c !== null ) {
            this.hideEvent = false;
          }

          // Modified date
          this.modified = moment(this.project.value.LastModifiedDate).fromNow();
        }
      }
    });
  </script>
</polymer-element>