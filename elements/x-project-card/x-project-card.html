<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-progress/paper-progress.html">
<link rel="import" href="/bower_components/core-icons/core-icons.html">
<link rel="import" href="/bower_components/core-icons/iconsets/social-icons.html">
<link rel="import" href="/bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="/elements/x-iconset/x-iconset.html">
<link rel="import" href="/elements/process-arrow/process-arrow.html">
<link rel="import" href="/elements/corner-ribbon/corner-ribbon.html">

<polymer-element name="x-project-card" attributes="project">
  <template>
    <style>
      :host {
        position: relative;
        overflow: visible;
      }
      .card-inner {
        display: block;
        background-color: #fff;
        padding: 10px;
        position: relative;
        overflow: hidden;
        box-shadow: 0px 2px 5px rgba(0,0,0, .3);
      }
      [lost].card-inner {
        opacity: .5;
        box-shadow: 0px 2px 5px rgba(0,0,0, .2);
      }

      /* Favorited */
      :host([favorite]) #favorite {
        fill: #dd2c00;
      }

      /* Other icons, and not favorited */
      paper-icon-button, core-icon {
        fill: rgba(0,0,0, 0.3);
      }

      core-icon {
        margin-right: 0.5em;
      }

      .align-right {
        text-align: right;
      }

      h1, h2 {
        font-weight: 300;
      }

      h1 {
        margin: 0 0 15px 0;
      }

      h2 {
        margin: 0;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }

      #amount {
        white-space: nowrap;
        font-size: 1.5em;
      }

      #description {
        margin: 10px 0;
      }

      #modified {
        font-size: 0.7em;
        margin: 0.2em 0;
      }

      .face {
        display: inline-block;
        background: transparent 50% 50%;
        background-size: cover;
        border-radius: 4em;
      }
      .face-user {
        width: 2em;
        height: 2em;
      }
      .face-owner {
        width: 4em;
        height: 4em;
      }

      .owner {
        margin-right: 1em;
      }

      .owner-name {
        font-size: 0.6em;
        font-weight: 400;
      }

      corner-ribbon[lost] {
        background-color: #222;
      }

      corner-ribbon core-icon {
        fill: #fff;
      }

    </style>
    <x-iconset></x-iconset>
    <div class="card-inner" vertical layout lost?="{{ project.value.IsClosed &amp;&amp; !project.value.IsWon }}">

      <template if="{{ project.value.IsClosed }}">
        <template if="{{ project.value.IsWon}}">
          <corner-ribbon><core-icon icon="custom-icons:crown" size="18"></core-icon>Won</corner-ribbon>
        </template>
        <template if="{{ !project.value.IsWon}}">
          <corner-ribbon lost>Lost</corner-ribbon>
        </template>
      </template>

      <!-- Title bar-->
      <div layout horizontal>
        <div class="owner" layout vertical center>
          <span class="face face-owner" title="{{ project.value.Owner.Name }}" style="background-image: url({{ '//api.fum.futurice.com/photo/' + project.value.Owner.Alias }})"></span>
          <span class="owner-name">{{ project.value.Owner.Name }}</span>
        </div>
        <h1 class="project-title" flex>{{ project.value.Name }}</h1>
        <paper-icon-button id="favorite" icon="favorite" on-tap="{{ favoriteTapped }}"></paper-icon-button>
      </div>

      <!-- Opportunity section  -->
      <div horizontal layout justified>
        <div vertical layout>
          <h2>{{ project.value.Account.Name }}</h2>
          <div hidden?="{{ project.value.IsClosed }}" horizontal layout>
            <core-icon icon="custom-icons:skull"></core-icon>
            <span>DL {{ dl }}</span>
          </div>
        </div>
        <div  class="align-right" vertical layout>
          <span id="amount">{{ amount }} kâ‚¬</span>
          <span>
            <template repeat="{{ username in project.value.FavoritedBy }}">
              <span class="face face-user" style="background-image: url({{ '//api.fum.futurice.com/photo/' + username }})"></span>
            </template>
          </span>
        </div>
      </div>

      <!-- Project section -->
      <div horizontal layout>
        <div vertical layout flex>
          <div horizontal layout hidden?="{{ hideEvent }}">
            <core-icon icon="event"></core-icon>
            <span>{{ project.value.Budgeted_Work_Start_Date__c || "TBD" }} - {{ project.value.Budgeted_Work_End_Date__c || "TBD" }}</span>
          </div>
          <div id="description" class="project-description">{{ project.value.Description }}</div>
          <div id="modified" horizontal layout>
            <p><core-icon icon="history" size="14"></core-icon>{{ modified }}</p>
          </div>
          <template if="{{ !project.value.IsClosed }}">
            <process-arrow stages="{{ stages }}" currentStageIndex="{{ stageIndex }}"></process-arrow>
          </template>
        </div>
      </div>

    </div>
  </template>
  <script src="../../bower_components/moment/moment.js"></script>
  <script>
    Polymer('x-project-card', {
      publish: {
        favorite: {
          value: false,
          reflect: true
        }
      },
      hideEvent: true,
      favoriteTapped: function(event, detail, sender) {
        this.fire('favorite-tap', {project: this.project});
      },
      stages: [
        "Unqualified",
        "Qualified",
        "Working on Proposal",
        "Closing",
        "Contract negotiations"
      ],
      projectChanged: function(){
        if (!!this.project) {

          this.stageIndex = this.stages.indexOf(this.project.value.StageName);

          // Hide dates if not available
          if (this.project.value.Budgeted_Work_Start_Date__c !== null || this.project.value.Budgeted_Work_End_Date__c !== null ) {
            this.hideEvent = false;
          }

          // Modified date
          this.modified = moment(this.project.value.LastModifiedDate).fromNow();

          // DL date from now
          this.dl = moment(this.project.value.CloseDate).fromNow();

          // Rounded amount
          this.amount = Math.round(this.project.value.Amount / 1000);
        }
      }
    });
  </script>
</polymer-element>