<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-progress/paper-progress.html">
<link rel="import" href="/bower_components/core-icons/core-icons.html">
<link rel="import" href="/bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="/elements/x-iconset/x-iconset.html">

<polymer-element name="x-project-card" attributes="project">
  <template>
    <style>
      :host {
        position: relative;
        overflow: visible;
      }
      .card-inner {
        display: block;
        background-color: #fff;
        padding: 10px;
        position: relative;
        box-shadow: 0px 2px 5px rgba(0,0,0, .3);
      }
      [lost].card-inner {
        opacity: .5;
        box-shadow: 0px 2px 5px rgba(0,0,0, .2);
      }

      paper-icon-button {
        fill: #e0e0e0;
      }
      :host([favorite]) paper-icon-button {
        fill: #dd2c00;
      }

      .align-right {
        text-align: right;
      }

      h1, h2 {
        font-weight: 300;
      }

      h1 {
        margin: 0 0 15px 0;
      }

      h2 {
        margin: 0;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }

      paper-progress {
        width: 100%;
      }

      paper-progress::shadow #activeProgress {
        background-color: #8bc34a;
      }

      [lost] paper-progress::shadow #activeProgress {
        background-color: #ff6e40;
      }

      #probability {
        font-size: 2em;
      }

      #amount {
        white-space: nowrap;
        font-size: 1.5em;
      }

      #description {
        margin: 10px 0;
      }

      #modified {
        font-size: 0.7em;
      }

      .face {
        display: inline-block;
        background: transparent 50% 50%;
        background-size: cover;
        border-radius: 4em;
      }
      .face-user {
        width: 2em;
        height: 2em;
      }
      .face-owner {
        width: 4em;
        height: 4em;
        margin-right: 1em;
      }

    </style>
    <x-iconset></x-iconset>
    <div class="card-inner" vertical layout lost?="{{ project.value.IsClosed &amp;&amp; !project.value.IsWon }}">

      <!-- Title bar-->
      <div layout horizontal>
        <core-tooltip label="{{ project.value.Owner.Name }}" position="above">
          <span class="face face-owner" style="background-image: url({{ '//api.fum.futurice.com/photo/' + project.value.Owner.Alias }})"></span>
        </core-tooltip>
        <h1 class="project-title" flex>{{ project.value.Name }}</h1>
        <paper-icon-button id="favorite" icon="favorite" on-tap="{{ favoriteTapped }}"></paper-icon-button>
      </div>

      <!-- Opportunity section  -->
      <div horizontal layout justified>
        <div vertical layout>
          <h2>{{ project.value.Account.Name }}</h2>
          <div hidden?="{{ project.value.IsClosed }}" horizontal layout>
            <core-icon icon="custom-icons:skull"></core-icon>
            <span>DL {{ dl }}</span>
          </div>
        </div>
        <div  class="align-right" vertical layout>
          <span id="amount">{{ amount }} kâ‚¬</span>
          <span>
            <template repeat="{{ username in project.value.FavoritedBy }}">
              <span class="face face-user" style="background-image: url({{ '//api.fum.futurice.com/photo/' + username }})"></span>
            </template>
          </span>
        </div>
      </div>

      <!-- Project section -->
      <div horizontal layout>
        <div vertical layout flex>
          <div horizontal layout hidden?="{{ hideEvent }}">
            <core-icon icon="event"></core-icon>
            <span>{{ project.value.Budgeted_Work_Start_Date__c || "TBD" }} - {{ project.value.Budgeted_Work_End_Date__c || "TBD" }}</span>
          </div>
          <div id="description" class="project-description">{{ project.value.Description }}</div>
          <core-tooltip label="{{ stage.name }}">
            <paper-progress value="{{ stage.number }}"></paper-progress>
          </core-tooltip>
          <div id="modified" horizontal layout>
            <div>Modified: {{ modified }}</div>
          </div>
        </div>
      </div>

    </div>
  </template>
  <script src="../../bower_components/moment/moment.js"></script>
  <script>
    Polymer('x-project-card', {
      publish: {
        favorite: {
          value: false,
          reflect: true
        }
      },
      hideEvent: true,
      favoriteTapped: function(event, detail, sender) {
        this.fire('favorite-tap', {project: this.project});
      },
      stageNumbers: {
        "Unqualified": 0,
        "Qualified": 20,
        "Working on Proposal": 40,
        "Closing": 60,
        "Contract negotiations": 80,
        "Won": 100,
        "Lost": 100
      },
      projectChanged: function(){
        this.stage = {};

        if (!!this.project) {
          if (this.project.value.IsClosed) {
            if (this.project.value.IsWon) {
              this.stage.name = "Won";
            } else {
              this.stage.name = "Lost";
            }
          } else {
            this.stage.name = this.project.value.StageName;
          }
          this.stage.number = this.stageNumbers[this.stage.name];


          // Hide dates if not available
          if (this.project.value.Budgeted_Work_Start_Date__c !== null || this.project.value.Budgeted_Work_End_Date__c !== null ) {
            this.hideEvent = false;
          }

          // Modified date
          this.modified = moment(this.project.value.LastModifiedDate).fromNow();

          // DL date from now
          this.dl = moment(this.project.value.CloseDate).fromNow();

          // Rounded amount
          this.amount = Math.round(this.project.value.Amount / 1000);
        }
      }
    });
  </script>
</polymer-element>